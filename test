{
  "size": 10000,  
  "_source": ["@timestamp", "access_referrer.keyword"],  
  "query": {
    "bool": {
      "must": [
        { "exists": { "field": "access_referrer.keyword" } },
        {
          "bool": {
            "should": [
              { "wildcard": { "access_referrer.keyword": "*hasInForcePolicy=Yes*" } },
              { "wildcard": { "access_referrer.keyword": "*hasInForcePolicy=No*" } },
              { "wildcard": { "access_referrer.keyword": "*hasEligibleOutOfForcePolicy=Yes*" } },
              { "wildcard": { "access_referrer.keyword": "*hasEligibleOutOfForcePolicy=No*" } }
            ],
            "minimum_should_match": 1
          }
        }
      ]
    }
  },
  "script_fields": {
    "date": {
      "script": {
        "source": "ZonedDateTime.ofInstant(Instant.ofEpochMilli(doc['@timestamp'].value.millis), ZoneId.of('UTC')).format(DateTimeFormatter.ofPattern('dd/MM/yyyy'))",
        "lang": "painless"
      }
    },
    "customer_id": {
      "script": {
        "source": """
          if (doc.containsKey('access_referrer.keyword')) {
            String ref = doc['access_referrer.keyword'].value;
            int start = ref.indexOf('/documents/customers/') + 21;
            int end = ref.indexOf('/count', start);
            if (start > 20 && end > start) {
              return ref.substring(start, end);
            }
          }
          return null;
        """,
        "lang": "painless"
      }
    },
    "status": {
      "script": {
        "source": """
          String ref = doc['access_referrer.keyword'].value;
          boolean hasActive = ref.contains("hasInForcePolicy=Yes");
          boolean hasOOF = ref.contains("hasEligibleOutOfForcePolicy=Yes");

          if (hasActive && hasOOF) {
            return "Active&OOF";
          } else if (hasActive) {
            return "OnlyActive";
          } else if (hasOOF) {
            return "NotActive&OOF";
          } else {
            return "NotActive&NotOOF";
          }
        """,
        "lang": "painless"
      }
    }
  }
}